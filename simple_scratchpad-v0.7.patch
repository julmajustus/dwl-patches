From e1625b34d9ba34115762e671722a709eaea8c889 Mon Sep 17 00:00:00 2001
From: julmajustus <julmajustus@tutanota.com>
Date: Mon, 23 Dec 2024 21:30:12 +0200
Subject: [PATCH] Simple scratchpad

---
 config.def.h        |  3 ++
 dwl.c               | 23 +++++++++++++
 simple_scratchpad.c | 83 +++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 109 insertions(+)
 create mode 100644 simple_scratchpad.c

diff --git a/config.def.h b/config.def.h
index 22d2171..b0d8c23 100644
--- a/config.def.h
+++ b/config.def.h
@@ -136,6 +136,9 @@ static const Key keys[] = {
 	{ MODKEY,                    XKB_KEY_Return,     zoom,           {0} },
 	{ MODKEY,                    XKB_KEY_Tab,        view,           {0} },
 	{ MODKEY|WLR_MODIFIER_SHIFT, XKB_KEY_C,          killclient,     {0} },
+	{ MODKEY|WLR_MODIFIER_SHIFT, XKB_KEY_Z,          addscratchpad,  {0} },
+	{ MODKEY|WLR_MODIFIER_CTRL,  XKB_KEY_z,          togglescratchpad,{0} },
+	{ MODKEY,                    XKB_KEY_z,          removescratchpad,{0} },
 	{ MODKEY,                    XKB_KEY_t,          setlayout,      {.v = &layouts[0]} },
 	{ MODKEY,                    XKB_KEY_f,          setlayout,      {.v = &layouts[1]} },
 	{ MODKEY,                    XKB_KEY_m,          setlayout,      {.v = &layouts[2]} },
diff --git a/dwl.c b/dwl.c
index a2711f6..44a4cd3 100644
--- a/dwl.c
+++ b/dwl.c
@@ -141,6 +141,7 @@ typedef struct {
 	uint32_t tags;
 	int isfloating, isurgent, isfullscreen;
 	uint32_t resize; /* configure serial of a pending resize */
+	struct wl_list link_temp;
 } Client;
 
 typedef struct {
@@ -243,6 +244,7 @@ typedef struct {
 } SessionLock;
 
 /* function declarations */
+static void addscratchpad(const Arg *arg);
 static void applybounds(Client *c, struct wlr_box *bbox);
 static void applyrules(Client *c);
 static void arrange(Monitor *m);
@@ -317,6 +319,7 @@ static void printstatus(void);
 static void powermgrsetmode(struct wl_listener *listener, void *data);
 static void quit(const Arg *arg);
 static void rendermon(struct wl_listener *listener, void *data);
+static void removescratchpad(const Arg *arg);
 static void requestdecorationmode(struct wl_listener *listener, void *data);
 static void requeststartdrag(struct wl_listener *listener, void *data);
 static void requestmonstate(struct wl_listener *listener, void *data);
@@ -341,6 +344,7 @@ static void tile(Monitor *m);
 static void togglefloating(const Arg *arg);
 static void togglefullscreen(const Arg *arg);
 static void toggletag(const Arg *arg);
+static void togglescratchpad(const Arg *arg);
 static void toggleview(const Arg *arg);
 static void unlocksession(struct wl_listener *listener, void *data);
 static void unmaplayersurfacenotify(struct wl_listener *listener, void *data);
@@ -413,6 +417,9 @@ static struct wlr_box sgeom;
 static struct wl_list mons;
 static Monitor *selmon;
 
+static struct wl_list scratchpad_clients;
+static int scratchpad_visible = 0;
+
 #ifdef XWAYLAND
 static void activatex11(struct wl_listener *listener, void *data);
 static void associatex11(struct wl_listener *listener, void *data);
@@ -432,6 +439,7 @@ static xcb_atom_t netatom[NetLast];
 /* attempt to encapsulate suck into one file */
 #include "client.h"
 
+#include "simple_scratchpad.c"
 /* function implementations */
 void
 applybounds(Client *c, struct wlr_box *bbox)
@@ -1263,6 +1271,19 @@ destroynotify(struct wl_listener *listener, void *data)
 	wl_list_remove(&c->destroy.link);
 	wl_list_remove(&c->set_title.link);
 	wl_list_remove(&c->fullscreen.link);
+	/* Check if destroyed client was part of scratchpad_clients 
+	 * and clean it from the list if so. */
+	if (scratchpad_visible) {
+		if (c && wl_list_length(&scratchpad_clients) > 0) {
+			Client *sc;
+			wl_list_for_each(sc, &scratchpad_clients, link_temp) {
+				if (sc == c) {
+					remove_from_scratchpad(c);
+					break;
+				}
+			}
+		}
+	}
 #ifdef XWAYLAND
 	if (c->type != XDGShell) {
 		wl_list_remove(&c->activate.link);
@@ -2535,6 +2556,8 @@ setup(void)
 	wl_list_init(&clients);
 	wl_list_init(&fstack);
 
+	wl_list_init(&scratchpad_clients);
+
 	xdg_shell = wlr_xdg_shell_create(dpy, 6);
 	LISTEN_STATIC(&xdg_shell->events.new_toplevel, createnotify);
 	LISTEN_STATIC(&xdg_shell->events.new_popup, createpopup);
diff --git a/simple_scratchpad.c b/simple_scratchpad.c
new file mode 100644
index 0000000..fda94cf
--- /dev/null
+++ b/simple_scratchpad.c
@@ -0,0 +1,83 @@
+/* ************************************************************************** */
+/*                                                                            */
+/*                                                        :::      ::::::::   */
+/*   simple_scratchpad.c                                :+:      :+:    :+:   */
+/*                                                    +:+ +:+         +:+     */
+/*   By: jmakkone <jmakkone@student.hive.fi>        +#+  +:+       +#+        */
+/*                                                +#+#+#+#+#+   +#+           */
+/*   Created: 2024/12/19 19:35:02 by jmakkone          #+#    #+#             */
+/*   Updated: 2024/12/23 21:18:45 by jmakkone         ###   ########.fr       */
+/*                                                                            */
+/* ************************************************************************** */
+
+
+static void
+add_to_scratchpad(Client *c) {
+	Client *cc;
+
+	wl_list_for_each(cc, &scratchpad_clients, link_temp) {
+	if (cc == c)
+			return;
+	}
+    if (!c->isfloating) {
+        setfloating(c, 1);
+    }
+    wl_list_insert(&scratchpad_clients, &c->link_temp);
+}
+
+static void
+toggle_scratchpad(void) {
+	Client *c;
+	Monitor *m = selmon;
+
+	scratchpad_visible = !scratchpad_visible;
+	if (scratchpad_visible) {
+		wl_list_for_each(c, &scratchpad_clients, link_temp) {
+			c->mon = m;
+			c->tags = m->tagset[m->seltags];
+			arrange(m);
+			focusclient(c, 1);
+			
+		}
+	} else {
+		wl_list_for_each(c, &scratchpad_clients, link_temp) {
+			c->tags = 0;
+			arrange(m);
+		}
+	}
+}
+
+static void
+remove_from_scratchpad(Client *c) {
+    wl_list_remove(&c->link_temp);
+}
+
+void
+addscratchpad(const Arg *arg)
+{
+    Client *c = focustop(selmon);
+    if (c)
+        add_to_scratchpad(c);
+}
+
+void
+togglescratchpad(const Arg *arg)
+{
+    toggle_scratchpad();
+}
+
+void
+removescratchpad(const Arg *arg)
+{
+    Client *sc, *c = focustop(selmon);
+
+    if (c && wl_list_length(&scratchpad_clients) > 0) {
+        /* Check if c is in scratchpad_clients */
+        wl_list_for_each(sc, &scratchpad_clients, link_temp) {
+            if (sc == c) {
+                remove_from_scratchpad(c);
+                break;
+            }
+        }
+    }
+}
-- 
2.45.2

